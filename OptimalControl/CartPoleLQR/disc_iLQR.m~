close all

T  = 5;
h = 0.01;

mc = 3;
mp = 5;
l = 0.5;
g = 9.81;
x0 = [1; 0; pi/12; 0];
u0 = 0;

Q = diag([1, 0, 0, 0]);
R = 0.01;

nx = numel(x0);
nu = numel(u0);

setup = struct('mc', mc, 'mp', mp, 'l', l, 'g', g, ...
    'Q', Q, 'R', R, 'T', T, 'h', h, ...
    'nx', numel(x0), 'nu', numel(u0));

us = zeros(nu, T/h+1);
Js = zeros(1, T/h+1);
Js_pre = Js;

[t, x] = ode45(@(t,x) SolCart(t,x,u0,setup), 0:h:T, x0);
xs = x';

tol = 1e-6;
max_iter = 10;
iter = 0;
err = inf;
while iter < max_iter && err > tol
    [Ks, ks] = BackwardLQR(xs, us, setup);
    [xs, us, Js] = ForwardLQR(xs, us, Ks, ks, setup);
    
    err = norm(Js - Js_pre);
    Js_pre = Js;
    
    fprintf('Iter #%d, (J sum)=%.4f, (J change)=%.4f \n', iter, sum(Js), err)
    iter = iter + 1;
end

showCartPole(t, xs', false)

function dxdt = SolCart(~,x,u,setup)
%     p = x(1);
    pdot = x(2);
    th = x(3);
    thdot = x(4);
    
    mc = setup.mc;
    mp = setup.mp;
    l = setup.l;
    g = setup.g;
    
    % H*qddot + C*qdot + E = D*u
    H = [mc+mp, mp*l*cos(th); cos(th), l];
    C = [0, mp*l*thdot*sin(th); 0, 0];
    E = [0; -g*sin(th)];
    D = [1; 0];
    
    dotdot = -H\C*[pdot; thdot] - H\E + H\D*u;
    
    dxdt = [pdot; dotdot(1); thdot; dotdot(2)];
end

function [Ks, ks] = BackwardLQR(xs, us, setup)
    
    Q = setup.Q;
    R = setup.R;
    T = setup.T;
    h = setup.h;
    nx = setup.nx;
    nu = setup.nu;
    
    C = blkdiag(Q, R);
    V = zeros(size(Q));
    v = zeros(nx, 1);
    
    Ks = zeros(nu, nx, T/h+1);
    ks = zeros(nu, T/h+1);
    
    for i = T/h+1:-1:1
        x = xs(:, i);
        u = us(:, i);
        a = dlarray([x; u]);
        [p_g, pdot_g, th_g, thdot_g] = dlfeval(@(x)CartDyn(x,setup), a);
        F = extractdata([p_g, pdot_g, th_g, thdot_g]');
        
        Qf = C + F'*V*F;
        q = blkdiag(Q,R)*[x; u] + F'*v;
        qx = q(1:nx);
        qu = q(nx+1:end);
        Qxx = Qf(1:nx,1:nx);
        Qux = Qf(nx+nu,1:nx);
        Qxu = Qf(1:nx,nx+nu);
        Quu = Qf(nx+nu,nx+nu);
        K = -Quu\Qux;
        k = -Quu\qu;
        V = Qxx + Qxu*K + K'*Qux + K'*Quu*K;
        v = qx + Qxu*k;
        Ks(:,:,i) = K;
        ks(:, i) = k;
    end
end

function [p_g, pdot_g, th_g, thdot_g] = CartDyn(x, setup)
    
    p = x(1);
    pdot = x(2);
    th = x(3);
    thdot = x(4);
    u = x(5);
    
    mc = setup.mc;
    mp = setup.mp;
    l = setup.l;
    g = setup.g;
    h = setup.h;
    
%     thddot = (g*sin(th)-cos(th)*(u+mp*l*thdot^2*sin(th))/(mc+mp)) / ...
%         (l-l*mp*cos(th)^2/(mc+mp));
%     pddot = (u+mp*l*(thdot^2*sin(th)-thddot*cos(th)))/(mc+mp);
%     
%     p_new = p + pdot*h + 1/2*pddot*h^2;
%     th_new = th + thdot*h + 1/2*thddot*h^2;
%     pdot_new = pdot + pddot*h;
%     thdot_new = thdot + thddot*h;
    
    % H*qddot + C*qdot + E = D*u
    H = [mc+mp, mp*l*cos(th); cos(th), l];
    C = [0, mp*l*thdot*sin(th); 0, 0];
    E = [0; -g*sin(th)];
    D = [1; 0];
    
    dotdot = 1/(H(1,1)*H(2,2)-H(1,2)*H(2,1)) * [H(2,2), -H(1,2); -H(2,1), H(1,1)]...
        *(-C*[pdot; thdot] - E + D*u);
    
    p_new = p + pdot*h + 1/2*dotdot(1)*h^2;
    th_new = th + thdot*h + 1/2*dotdot(2)*h^2;
    pdot_new = pdot + dotdot(1)*h;
    thdot_new = thdot + dotdot(2)*h;
    
    p_g = dlgradient(p_new,x);
    pdot_g = dlgradient(pdot_new,x);
    th_g = dlgradient(th_new,x);
    thdot_g = dlgradient(thdot_new,x);
    
    g
    
end

function [xs_new, us_new, Js_new] = ForwardLQR(xs, us, Ks, ks, setup)
    
    T = setup.T;
    h = setup.h;
    
    Q = setup.Q;
    R = setup.R;
    
    xs_new = zeros(size(xs));
    us_new = zeros(size(us));
    Js_new = zeros(T/h+1,1);
    
    xs_new(:,1) = xs(:,1);
    
    options = odeset('RelTol',1e-6,'AbsTol',1e-9);
    
    ds = zeros([size(xs,1), 1]);
    for i = 1:T/h
        u = us(:,i) + Ks(:,:,i)*ds + ks(:,i);
        x0 = xs(:,i);
        [~, x] = ode45(@(t,x) SolCart(t,x,u,setup), [0, h], x0, options);
        
        xs_new(:,i+1) = x(end,:)';
        ds = xs_new(:,i+1) - xs(:,i+1);
        us_new(:,i) = u;
        
        Js_new(i) = 1/2*x(end,:)*Q*x(end,:)'+1/2*u'*R*u;
    end
end
